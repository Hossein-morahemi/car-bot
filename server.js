const express = require("express");
const axios = require("axios");
const cron = require("node-cron");

const app = express();

// ======================
// Telegram Bot Settings
// ======================
const BOT_TOKEN = process.env.BOT_TOKEN;
const CHANNEL_ID = process.env.CHANNEL_ID;

// ======================
// Ù„ÛŒØ³Øª Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§ Ùˆ Ù‚ÛŒÙ…Øª Ú©Ø§Ø±Ø®Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†
// ======================
const cars = [
  // ================= Ø¯Ø§Ø®Ù„ÛŒ =================
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ù¾Ø±Ø§ÛŒØ¯ 111", price: 740_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ù¾Ø±Ø§ÛŒØ¯ 131", price: 710_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ù¾Ø±Ø§ÛŒØ¯ 151", price: 740_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø³Ø§ÛŒÙ†Ø§", price: 929_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø³Ø§ÛŒÙ†Ø§ Ø¯ÙˆÚ¯Ø§Ù†Ù‡", price: 993_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ú©ÙˆØ¦ÛŒÚ© S", price: 926_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ú©ÙˆØ¦ÛŒÚ© RS", price: 930_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ú©ÙˆØ¦ÛŒÚ© GXR", price: 947_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø³Ù‡Ù†Ø¯", price: 1_068_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø³Ù‡Ù†Ø¯ Ø§ØªÙˆ", price: 1_295_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø¯Ù†Ø§ Ù¾Ù„Ø§Ø³", price: 1_560_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø±Ø§Ù†Ø§", price: 1_290_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ù¾Ú˜Ùˆ 207 TU3", price: 1_282_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ù¾Ú˜Ùˆ 207 Ø¯Ù†Ø¯Ù‡ Ù¾Ø§Ù†Ø§", price: 1_572_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ù¾Ú˜Ùˆ 207 Ø§ØªÙˆ Ù¾Ø§Ù†Ø§", price: 1_870_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "ØªØ§Ø±Ø§ V1", price: 1_580_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "ØªØ§Ø±Ø§ V4", price: 1_885_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø³ÙˆØ±Ù† XU7P Ø¨Ø±Ù‚", price: 1_287_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø³ÙˆØ±Ù† XU7P Ø³ÛŒÙ…", price: 1_390_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø³ÙˆØ±Ù† Ø¯ÙˆÚ¯Ø§Ù†Ù‡ Ø¨Ø±Ù‚", price: 1_400_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø³ÙˆØ±Ù† Ø¯ÙˆÚ¯Ø§Ù†Ù‡ Ø³ÛŒÙ…", price: 1_441_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø¯Ù†Ø§ Ûµ Ø¯Ù†Ø¯Ù‡ Ø¨ÙˆØ±Ø³ÛŒ", price: 1_560_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø¯Ù†Ø§ Û¶ Ø¯Ù†Ø¯Ù‡", price: 1_646_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ø¯Ù†Ø§ Ø§ØªÙˆ", price: 1_987_000_000 },
  { type: "Ø¯Ø§Ø®Ù„ÛŒ", model: "Ù¾Ú˜Ùˆ 405 Ø¨Ø±Ù‚", price: 1_330_000_000 },

  // ================= Ú†ÛŒÙ†ÛŒ =================
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ù‡Ø§ÛŒÙ…Ø§ S5", price: 2_780_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ù‡Ø§ÛŒÙ…Ø§ S7", price: 3_145_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ù‡Ø§ÛŒÙ…Ø§ S8", price: 3_528_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ù‡Ø§ÛŒÙ…Ø§ X7", price: 3_300_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ø¬Ú© J4", price: 1_750_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ø¬Ú© J7", price: 3_380_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ø¬Ú© X5", price: 3_280_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ø¬Ú© A5", price: 3_127_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ø¬Ú© T9", price: 5_170_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "ØªÛŒÚ¯Ùˆ 7 Ù¾Ø±Ù…ÛŒÙˆÙ…", price: 4_380_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "ØªÛŒÚ¯Ùˆ 7 Ø¯Ùˆ Ø¯Ù", price: 4_750_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "ØªÛŒÚ¯Ùˆ 8 IE", price: 6_070_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ú†Ø§Ù†Ú¯ CS55", price: 4_450_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ù…Ø²Ø¯Ø§ CX30", price: 7_600_000_000 },
  { type: "Ú†ÛŒÙ†ÛŒ", model: "Ù…Ø²Ø¯Ø§ EZ6", price: 8_490_000_000 },

  // ================= ÙˆØ§Ø±Ø¯Ø§ØªÛŒ =================
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ù„Ù†Ø¯Ú©Ø±ÙˆØ²", price: 42_700_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ù¾Ø±Ø§Ø¯Ùˆ", price: 26_700_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ø¨Ù†Ø² A200", price: 10_250_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ø¢Ø¦ÙˆØ¯ÛŒ Q4", price: 9_450_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ú©ÛŒØ§ K5", price: 6_700_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ø³ÙˆÙ†Ø§ØªØ§", price: 7_450_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "ØªÙˆØ³Ø§Ù†", price: 7_250_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ø§Ù„Ù†ØªØ±Ø§", price: 4_840_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ù‡ÙˆÙ†Ú¯Ú†ÛŒ", price: 5_048_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ø¨Ù†Ø² E200", price: 11_500_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ø¢Ø¦ÙˆØ¯ÛŒ A6", price: 14_200_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ù„Ú©Ø³ÙˆØ³ RX350", price: 18_500_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ú©Ù…Ø±ÛŒ Ú˜Ø§Ù¾Ù† Ú†Ø±Ù…", price: 9_500_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ú©Ù…Ø±ÛŒ Ú˜Ø§Ù¾Ù† Ù¾Ø§Ø±Ú†Ù‡", price: 9_000_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ú©ÛŒØ§ Ø³Ø±Ø§ØªÙˆ", price: 7_900_000_000 },
  { type: "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ", model: "Ù†ÛŒØ³Ø§Ù† ØªÛŒØ§Ù†Ø§", price: 8_100_000_000 },
];

// ======================
// Ø°Ø®ÛŒØ±Ù‡ Ù‚ÛŒÙ…Øª Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆÙ†Ø¯
// ======================
let lastPrices = {};

// ======================
// Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… Ø´ÛŒÚ© Markdown
// ======================
function buildMessage(carsList) {
  let message = "ðŸ“Š *Ù„ÛŒØ³Øª Ù‚ÛŒÙ…Øª Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§ (Ú©Ø§Ø±Ø®Ø§Ù†Ù‡â€ŒØ§ÛŒ)*\n\n";

  const categories = ["Ø¯Ø§Ø®Ù„ÛŒ", "Ú†ÛŒÙ†ÛŒ", "ÙˆØ§Ø±Ø¯Ø§ØªÛŒ"];
  categories.forEach(cat => {
    const catCars = carsList.filter(c => c.type === cat);
    if (catCars.length) {
      message += `*ðŸ·ï¸ ${cat}:*\n`;
      message += "```Ù†Ø§Ù… Ø®ÙˆØ¯Ø±Ùˆ               | Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)       | ðŸ”º/ðŸ”»\n";
      message += "------------------------|------------------|------\n";

      catCars.forEach(c => {
        let trend = "âšªï¸";
        if (lastPrices[c.model] !== undefined) {
          trend = c.price > lastPrices[c.model] ? "ðŸŸ¢" : c.price < lastPrices[c.model] ? "ðŸ”´" : "âšªï¸";
        }

        const modelPadded = c.model.padEnd(23, " ");
        const pricePadded = c.price.toLocaleString().padEnd(16, " ");

        message += `${modelPadded}| ${pricePadded}| ${trend}\n`;

        lastPrices[c.model] = c.price;
      });
      message += "```\n\n";
    }
  });

  return message;
}

// ======================
// Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
// ======================
async function sendPrices() {
  try {
    const message = buildMessage(cars);
    console.log("Ù¾ÛŒØ§Ù… Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯:\n", message);

    await axios.post(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      chat_id: CHANNEL_ID,
      text: message,
      parse_mode: "Markdown"
    });

    console.log("âœ… Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!");
  } catch (err) {
    console.log("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…:", err.message);
  }
}

// ======================
// Ú©Ø±ÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡
// ======================
cron.schedule("*/12 * * * *", () => sendPrices());

// ======================
// Ø³Ø±ÙˆØ± Express Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
// ======================
app.get("/", (req, res) => res.send("ðŸš€ Ø±Ø¨Ø§Øª Ø®ÙˆØ¯Ø±Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª!"));

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server started on port ${PORT}`));
